# --------------------------------------------------------------------------------------------------------------
# Nozzle Clean
#   written by Daniel Porrey
#   v1.0.0
#   Last Updated: 2/27/2026
# --------------------------------------------------------------------------------------------------------------

# --------------------------------------------------------------------------------------------------------------
# Usage
#
# Variable definitions only.
# 
# --------------------------------------------------------------------------------------------------------------
[gcode_macro _NOZZLE_CLEAN_CONFIG]
description: Configuration variables for NOZZLE_CLEAN
#
# Pad geometry (all in mm).
#
variable_pad_x: -1.5               # Pad "start" X (one end of the wipe line)
variable_pad_y: 95                 # Pad Y (for X-direction wipes) or pad start Y (for Y-direction wipes)
variable_pad_width: 7.8            # X size (left-to-right)
variable_pad_depth: 36.75          # Y size (front-to-back)
variable_pad_z: 3.5                # Z height to wipe at (absolute Z)

#
# Behavior
#
variable_wipe_axis: "Y"            # "X" = wipe back/forth in X at constant Y
                                   # "Y" = wipe back/forth in Y at constant X
variable_safe_z: 10.0              # Z used for travel moves (absolute Z)
variable_travel_f: 6000            # Travel feedrate (mm/min)
variable_wipe_f: 4000              # Wipe feedrate (mm/min)

#
# Default values
#
variable_default_temp: 200         # Default cleaning temp if TEMP not provided
variable_default_passes: 5         # The default number of times to wipe the nozzle
variable_default_keep_hotend_on: 1 # Keep the hotend running since this command is macro
                                   # will be used during a print.
#
# If you want the macro to always heat (True) or only heat if below target (False)
#
variable_always_heat: True

gcode:
  ; This macro only stores variables. No gcode required.

# --------------------------------------------------------------------------------------------------------------
# Usage:
#
# Default:
#     NOZZLE_CLEAN
#
# Custom temp/passes: 
#     NOZZLE_CLEAN TEMP=210 PASSES=8
#
# Temporary wipe height override: 
#     NOZZLE_CLEAN Z=0.6
#
# Keep hotend on when done:
#     NOZZLE_CLEAN TEMP=210 PASSES=8 KEEP_HOTEND_ON=1
#
# Turn hotend off when done:
#     NOZZLE_CLEAN TEMP=210 PASSES=8 KEEP_HOTEND_ON=0
#
# --------------------------------------------------------------------------------------------------------------
[gcode_macro NOZZLE_CLEAN]
description: Clean the nozzle using a cleaning pad.
# Optional parameters:
#   TEMP:           Nozzle cleaning temperature.
#   PASSES:         Number of wipe passes.
#   Z:              Override wipe Z height for this run.
#   KEEP_HOTEND_ON: Set to 1 to keep hotend on, 0 to turn hotend off when complete.
gcode:
  {% set cfg = printer["gcode_macro _NOZZLE_CLEAN_CONFIG"] %}
  
  {% set temp             = params.TEMP|default(cfg.default_temp)|int %}
  {% set passes           = params.PASSES|default(cfg.default_passes)|int %}
  {% set wipe_z           = params.Z|default(cfg.pad_z)|float %}
  {% set keep_hotend_on   = params.KEEP_HOTEND_ON|default(cfg.default_keep_hotend_on)|int %}
  
  {% set pad_x       = cfg.pad_x|float %}
  {% set pad_y       = cfg.pad_y|float %}
  {% set pad_w       = cfg.pad_width|float %}
  {% set pad_d       = cfg.pad_depth|float %}
  {% set axis        = (cfg.wipe_axis|string)|upper %}
  {% set safe_z      = cfg.safe_z|float %}
  {% set travel_f    = cfg.travel_f|int %}
  {% set wipe_f      = cfg.wipe_f|int %}
  {% set always_heat = cfg.always_heat %}

  #
  # Save the state.
  #
  SAVE_GCODE_STATE NAME=nozzle_clean_state
  
  #
  # Start heating the nozzle and do not wait.
  #
  {% if always_heat %}
    RESPOND TYPE=echo MSG="Heating to {temp}째C"
    M104 S{temp}
  {% else %}
    {% if printer.extruder.temperature < (temp - 2) %}
      RESPOND TYPE=echo MSG="Heating to {temp}째C"
      M104 S{temp}
    {% endif %}
  {% endif %}
    
  #
  # Home if not already homed.
  #
  {% if printer.toolhead.homed_axes != "xyz" %}
      #
      # Home
      #
      G28

      #
      # Finish all moves.
      #
      M400
  {% endif %}
  
  #
  # Set absolute positioning
  #
  G90

  #
  # Go to safe travel height first.
  #
  G1 Z{safe_z} F3000

  #
  # Calculate the center on the pad in the 
  # non-wipe axis.
  #
  {% set cx = pad_x + (pad_w / 2.0) %}
  {% set cy = pad_y + (cfg.pad_depth|float / 2.0) %}
  
  #
  # Move above pad start.
  #
  {% if axis == "X" %}
    G1 X{pad_x} Y{cy} F{travel_f}
  {% elif axis == "Y" %}
    G1 X{cx} Y{pad_y} F{travel_f}
  {% else %}
    {action_raise_error("_NOZZLE_CLEAN_CONFIG: variable_wipe_axis must be 'X' or 'Y'")}
  {% endif %}

  #
  # Wait for the nozzle to get to temperature.
  #
  {% if always_heat %}
    RESPOND TYPE=echo MSG="Waiting to reach temperature of {temp}째C"
    M109 S{temp}
  {% else %}
    {% if printer.extruder.temperature < (temp - 2) %}
     RESPOND TYPE=echo MSG="Waiting to reach temperature of {temp}째C"
      M109 S{temp}
    {% endif %}
  {% endif %}

  #
  # Finish all moves.
  #
  M400

  #
  # Drop to wipe height.
  #
  G1 Z{wipe_z} F3000

  #
  # Clean the nozzle with the specified
  # number of passes.
  #
  RESPOND TYPE=echo MSG="Cleaning nozzle..."
  {% for i in range(passes) %}
    {% if axis == "X" %}
      G1 X{(pad_x + pad_w)} Y{cy} F{wipe_f}
      G1 X{pad_x}           Y{cy} F{wipe_f}
    {% else %}
      G1 X{cx} Y{(pad_y + pad_d)} F{wipe_f}
      G1 X{cx} Y{pad_y}           F{wipe_f}
    {% endif %}
  {% endfor %}

  #
  # Lift and leave.
  #
  G1 Z{safe_z|round(3)} F3000

  #
  # Turn the hotend off if specified.
  #
  {% if not keep_hotendon %}
    M104 S0
  {% endif %}

  #
  # Finish all moves.
  #
  M400
  
  #
  # Display completed message.
  #
  RESPOND TYPE=echo MSG="Nozzle cleaning completed."

  #
  # Restore the state
  #
  RESTORE_GCODE_STATE NAME=nozzle_clean_state

# --------------------------------------------------------------------------------------------------------------
# Usage:
#
# Default:
#     NOZZLE_CLEAN_TEST
#
# --------------------------------------------------------------------------------------------------------------
[gcode_macro NOZZLE_CLEAN_TEST]
description: Test the nozzle cleaning without touching the pad or turning on the hotend.
gcode:
  {% set cfg = printer["gcode_macro _NOZZLE_CLEAN_CONFIG"] %}

  {% set passes = params.PASSES|default(cfg.default_passes)|int %}
  {% set z      = params.PASSES|default(cfg.pad_z)|int %}
  {% set ztest  = z + 3 %}
  
  NOZZLE_CLEAN TEMP=0 PASSES={passes} Z={ztest}

# --------------------------------------------------------------------------------------------------------------
# Usage:
#
# Default:
#     NOZZLE_PAD_EDGE
#
# Custom passes and inset: 
#     NOZZLE_PAD_EDGE PASSES=8 INSET=2
#
# Lower the height to perform an actual wipe: 
#     NOZZLE_CLEAN PASSES=8 INSET=3 Z=0.6
#
# (if using NOZZLE_PAD_EDGE for cleaning run
#  M109 S200 first)
#
# --------------------------------------------------------------------------------------------------------------
[gcode_macro NOZZLE_PAD_EDGE]
description: Trace the nozzle cleaning pad perimeter to test configuration.
# Optional parameters:
#   PASSES: Number of perimeter loops (default 2)
#   INSET:  Inset from pad edge in mm (default 0)
#   Z:      Override wipe Z height for this run (default 5.0)
gcode:
  {% set cfg = printer["gcode_macro _NOZZLE_CLEAN_CONFIG"] %}

  {% set passes   = params.PASSES|default(2)|int %}
  {% set inset    = params.INSET|default(0.0)|float %}
  {% set wipe_z   = params.Z|default(5.0)|float %}

  {% set x0       = cfg.pad_x|float %}
  {% set y0       = cfg.pad_y|float %}
  {% set w        = cfg.pad_width|float %}
  {% set d        = cfg.pad_depth|float %}
  {% set safe_z   = cfg.safe_z|float %}
  {% set travel_f = cfg.travel_f|int %}
  {% set wipe_f   = cfg.wipe_f|int %}

  #
  # Save the state.
  #
  SAVE_GCODE_STATE NAME=nozzle_edge_state

  #
  # Check the parameters.
  #
  {% if passes < 1 %}
    {action_raise_error("NOZZLE_PAD_EDGE: PASSES must be >= 1")}
  {% endif %}
  
  {% if inset < 0 %}
    {action_raise_error("NOZZLE_PAD_EDGE: INSET must be >= 0")}
  {% endif %}
  
  {% if (w - 2*inset) <= 0 or (d - 2*inset) <= 0 %}
    {action_raise_error("NOZZLE_PAD_EDGE: INSET too large for pad size")}
  {% endif %}

  #
  # Home if not already homed.
  #
  {% if printer.toolhead.homed_axes != "xyz" %}
      #
      # Home
      #
      G28

      #
      # Finish all moves.
      #
      M400
  {% endif %}

  #
  # Set absolute positioning
  #
  G90

  #
  # Compute inset rectangle.
  #
  {% set xi0 = x0 + inset %}
  {% set yi0 = y0 + inset %}
  {% set xi1 = x0 + w - inset %}
  {% set yi1 = y0 + d - inset %}

  #
  # Travel above pad.
  #
  G1 Z{safe_z} F3000

  #
  # Move to the front left corner of the pad.
  #
  G1 X{xi0} Y{yi0} F{travel_f}

  #
  # Down to height (defaults to 5mm if not specified).
  #
  G1 Z{wipe_z} F3000

  #
  # Trace the edge of the nozzle pad
  # the specified number of times.
  #
  RESPOND TYPE=echo MSG="Tracing nozzle pad edge..."
  {% for i in range(passes) %}
    G1 X{xi1} Y{yi0} F{wipe_f}
    G1 X{xi1} Y{yi1} F{wipe_f}
    G1 X{xi0} Y{yi1} F{wipe_f}
    G1 X{xi0} Y{yi0} F{wipe_f}
  {% endfor %}

  #
  # Lift
  #
  G1 Z{safe_z|round(3)} F3000

  #
  # Finish all moves.
  #
  M400
  
  #
  # Display completed message.
  #
  RESPOND TYPE=echo MSG="Nozzle pad trace completed."

  #
  # Restore the state
  #
  RESTORE_GCODE_STATE NAME=nozzle_edge_state